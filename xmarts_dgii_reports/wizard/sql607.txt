SELECT 	am.id,					
	am.id as invoice_id,					
	(					
	select					
		rc2.name				
	from					
		res_currency rc2				
	where					
		rc2.id = am.currency_id) as moneda,				
	rp.vat as rnc,					
	rp.name as customer_name,					
	case					
		when char_length(rp.vat) = 0 then ''				
		when char_length(rp.vat) = 9 then 'RNC'				
		when char_length(rp.vat) >= 11 then 'Cedula'				
		else ''				
	end as tipo_id,					
	case					
		when char_length(rp.vat) = 0 then ''				
		when char_length(rp.vat) = 9 then '1'				
		when char_length(rp.vat) >= 11 then '2'				
		else ''				
	end as codigo_id,					
	am.ref as ncf,					
	am.l10n_do_origin_ncf as ncf_modificado,					
	case 		
		when am.l10n_do_income_type = '01' then '01 - Ingresos por Operaciones (No Financieros)'	
		when am.l10n_do_income_type = '02' then '02 - Ingresos Financieros'	
		when am.l10n_do_income_type = '03' then '03 - Ingresos Extraordinarios'	
		when am.l10n_do_income_type = '04' then '04 - Ingresos por Arrendamientos'	
		when am.l10n_do_income_type = '05' then '05 - Ingresos por Venta de Activo Depreciable'	
		when am.l10n_do_income_type = '06' then '06 - Otros Ingresos'	
		else '' end as tipo_ingreso,	
	am.l10n_do_income_type as codigo_tipo_ingreso,		
	am.l10n_latam_document_type_id as tipo_ncf,					
	case 								
		when 	(						
				coalesce ((					
				select					
					sum(aml.credit)				
				from					
					account_move_line aml				
				where					
					aml.move_id = am.id				
					and aml.account_internal_type = 'other'				
					and aml.exclude_from_invoice_tab = true				
					and aml.name like '%ITBIS%'),				
				0) + coalesce ((					
				select					
					sum(aml.debit)				
				from					
					account_move_line aml				
				where					
					aml.move_id = am.id				
					and aml.account_internal_type = 'other'				
					and aml.exclude_from_invoice_tab = true				
					and aml.name like '%ITBIS%'),				
				0)					
			) = 0 and (am.ref like 'B01%'						
			or am.ref like 'B02%') then 'Ventas Locales Excentas'						
		when 	(						
				coalesce ((					
				select					
					sum(aml.credit)				
				from					
					account_move_line aml				
				where					
					aml.move_id = am.id				
					and aml.account_internal_type = 'other'				
					and aml.exclude_from_invoice_tab = true				
					and aml.name like '%ITBIS%'),				
				0) + coalesce ((					
				select					
					sum(aml.debit)				
				from					
					account_move_line aml				
				where					
					aml.move_id = am.id				
					and aml.account_internal_type = 'other'				
					and aml.exclude_from_invoice_tab = true				
					and aml.name like '%ITBIS%'),				
				0)					
			) = 0 and am.ref like 'B16%' then 'Ventas Excentas por Exportacion'						
		when 	(						
				coalesce ((					
				select					
					sum(aml.credit)				
				from					
					account_move_line aml				
				where					
					aml.move_id = am.id				
					and aml.account_internal_type = 'other'				
					and aml.exclude_from_invoice_tab = true				
					and aml.name like '%ITBIS%'),				
				0) + coalesce ((					
				select					
					sum(aml.debit)				
				from					
					account_move_line aml				
				where					
					aml.move_id = am.id				
					and aml.account_internal_type = 'other'				
					and aml.exclude_from_invoice_tab = true				
					and aml.name like '%ITBIS%'),				
				0)					
			) = 0 and (am.ref like 'B14%'						
			or am.ref like 'B15%') then 'Ventas Excentas por Destino'						
		when 	(						
				coalesce ((					
				select					
					sum(aml.credit)				
				from					
					account_move_line aml				
				where					
					aml.move_id = am.id				
					and aml.account_internal_type = 'other'				
					and aml.exclude_from_invoice_tab = true				
					and aml.name like '%ITBIS%'),				
				0) + coalesce ((					
				select					
					sum(aml.debit)				
				from					
					account_move_line aml				
				where					
					aml.move_id = am.id				
					and aml.account_internal_type = 'other'				
					and aml.exclude_from_invoice_tab = true				
					and aml.name like '%ITBIS%'),				
				0)					
			) > 0 and am.ref not like 'B04%' then 'Ventas Gravadas'						
		when 	(						
				coalesce ((					
				select					
					sum(aml.credit)				
				from					
					account_move_line aml				
				where					
					aml.move_id = am.id				
					and aml.account_internal_type = 'other'				
					and aml.exclude_from_invoice_tab = true				
					and aml.name like '%ITBIS%'),				
				0) + coalesce ((					
				select					
					sum(aml.debit)				
				from					
					account_move_line aml				
				where					
					aml.move_id = am.id				
					and aml.account_internal_type = 'other'				
					and aml.exclude_from_invoice_tab = true				
					and aml.name like '%ITBIS%'),				
				0)					
			) > 0 and am.ref like 'B04%' then 'Notas Credito Gravadas'						
		when 	(						
				coalesce ((					
				select					
					sum(aml.credit)				
				from					
					account_move_line aml				
				where					
					aml.move_id = am.id				
					and aml.account_internal_type = 'other'				
					and aml.exclude_from_invoice_tab = true				
					and aml.name like '%ITBIS%'),				
				0) + coalesce ((					
				select					
					sum(aml.debit)				
				from					
					account_move_line aml				
				where					
					aml.move_id = am.id				
					and aml.account_internal_type = 'other'				
					and aml.exclude_from_invoice_tab = true				
					and aml.name like '%ITBIS%'),				
				0)					
			) = 0 and am.ref like 'B04%' then 'Notas Credito Excentas'						
		else '' end as clasif_ingresos,							
	am.invoice_date as invoice_date,			
	to_char(am.invoice_date, 'DD/MM/YYYY') as fecha_emision,		
	coalesce ((			
	select			
		to_char(ap.payment_date, 'DD/MM/YYYY')		
	from			
		account_payment ap		
	where			
		ap.communication = am.name		
	order by			
		ap.id desc		
	limit 1),			
	'') as fecha_pago,			
	to_char(am.invoice_date, 'YYYYMMDD') as fecha_emision_amd,		
	coalesce ((			
	select			
		to_char(ap.payment_date, 'YYYYMMDD')		
	from			
		account_payment ap		
	where			
		ap.communication = am.name		
	order by			
		ap.id desc		
	limit 1),			
	'') as fecha_pago_retencion,			
	(coalesce ((					
	select					
		sum(aml.credit)				
	from					
		account_move_line aml				
	where					
		aml.move_id = am.id				
		and aml.account_internal_type = 'other'				
		and aml.exclude_from_invoice_tab = false),				
	0) + coalesce ((					
	select					
		sum(aml.debit)				
	from					
		account_move_line aml				
	where					
		aml.move_id = am.id				
		and aml.account_internal_type = 'other'				
		and aml.exclude_from_invoice_tab = false),				
	0)) as monto_facturado_aitbis,					
	(coalesce ((					
	select					
		sum(aml.credit)				
	from					
		account_move_line aml				
	where					
		aml.move_id = am.id				
		and aml.account_internal_type = 'other'				
		and aml.exclude_from_invoice_tab = true				
		and aml.name like '%ITBIS%'),				
	0) + coalesce ((					
	select					
		sum(aml.debit)				
	from					
		account_move_line aml				
	where					
		aml.move_id = am.id				
		and aml.account_internal_type = 'other'				
		and aml.exclude_from_invoice_tab = true				
		and aml.name like '%ITBIS%'),				
	0)) as monto_facturado_itbis,					
	(coalesce ((					
	select					
		sum(aml.credit)				
	from					
		account_move_line aml				
	inner join account_payment ap on					
		ap.id = aml.payment_id				
	inner join account_account aa on					
		aa.id = aml.account_id				
	where					
		aml.ref = am.name				
		and (aa.name like '%Reten%'				
		and aa.name like '%ITBIS%')				
		and ap.id = (				
		select				
			ap.id			
		from				
			account_payment ap			
		where				
			ap.communication = am.name			
		order by				
			ap.id desc			
		limit 1)),				
	0) + coalesce ((					
	select					
		sum(aml.debit)				
	from					
		account_move_line aml				
	inner join account_payment ap on					
		ap.id = aml.payment_id				
	inner join account_account aa on					
		aa.id = aml.account_id				
	where					
		aml.ref = am.name				
		and (aa.name like '%Reten%'				
		and aa.name like '%ITBIS%')				
		and ap.id = (				
		select				
			ap.id			
		from				
			account_payment ap			
		where				
			ap.communication = am.name			
		order by				
			ap.id desc			
		limit 1)),				
	0)) as itbis_retenido,					
	coalesce (null,					
	'') as itbis_percibido,					
	(coalesce ((					
	select					
		sum(aml.credit)				
	from					
		account_move_line aml				
	inner join account_payment ap on					
		ap.id = aml.payment_id				
	inner join account_account aa on					
		aa.id = aml.account_id				
	where					
		aml.ref = am.name				
		and aa.name like '%Reten%'				
		and aa.name like '%ISR%'				
		and ap.id = (				
		select				
			ap.id			
		from				
			account_payment ap			
		where				
			ap.communication = am.name			
		order by				
			ap.id desc			
		limit 1)),				
	0) + coalesce ((					
	select					
		sum(aml.debit)				
	from					
		account_move_line aml				
	inner join account_payment ap on					
		ap.id = aml.payment_id				
	inner join account_account aa on					
		aa.id = aml.account_id				
	where					
		aml.ref = am.name				
		and aa.name like '%Reten%'				
		and aa.name like '%ISR%'				
		and ap.id = (				
		select				
			ap.id			
		from				
			account_payment ap			
		where				
			ap.communication = am.name			
		order by				
			ap.id desc			
		limit 1)),				
	0)) as isr_retenido,					
	coalesce (null,					
	'') as isr_percibido,					
	(coalesce ((					
	select					
		sum(aml.credit)				
	from					
		account_move_line aml				
	where					
		aml.move_id = am.id				
		and aml.account_internal_type = 'other'				
		and aml.exclude_from_invoice_tab = true				
		and aml.name like '%ISC%'),				
	0) + coalesce ((					
	select					
		sum(aml.debit)				
	from					
		account_move_line aml				
	where					
		aml.move_id = am.id				
		and aml.account_internal_type = 'other'				
		and aml.exclude_from_invoice_tab = true				
		and aml.name like '%ISC%'),				
	0)) as monto_facturado_isc,					
	(( coalesce ((					
	select					
		sum(aml.credit)				
	from					
		account_move_line aml				
	where					
		aml.move_id = am.id				
		and aml.account_internal_type = 'other'				
		and aml.exclude_from_invoice_tab = true				
		and (aml.name not like '%Propina Legal%'				
		or aml.name not like '%ISC%'				
		or aml.name not like '%ITBIS%'				
		or aml.name not like '%ISR%')),				
	0) - coalesce ((					
	select					
		sum(aml.credit)				
	from					
		account_move_line aml				
	where					
		aml.move_id = am.id				
		and aml.account_internal_type = 'other'				
		and aml.exclude_from_invoice_tab = true				
		and (aml.name like '%ISR%'				
		or aml.name like '%ISC%'				
		or aml.name like '%ITBIS%'				
		or aml.name like '%ISR%')),				
	0)) + coalesce ((					
	select					
		sum(aml.debit)				
	from					
		account_move_line aml				
	where					
		aml.move_id = am.id				
		and aml.account_internal_type = 'other'				
		and aml.exclude_from_invoice_tab = true				
		and (aml.name not like '%ISR%'				
		or aml.name not like '%ISC%'				
		or aml.name not like '%ITBIS%'				
		or aml.name not like '%ISR%')),				
	0) - coalesce ((					
	select					
		sum(aml.debit)				
	from					
		account_move_line aml				
	where					
		aml.move_id = am.id				
		and aml.account_internal_type = 'other'				
		and aml.exclude_from_invoice_tab = true				
		and (aml.name like '%ISR%'				
		or aml.name like '%ISC%'				
		or aml.name like '%ITBIS%'				
		or aml.name like '%ISR%')),				
	0)) as monto_otros_imp,					
	(coalesce ((					
	select					
		sum(aml.credit)				
	from					
		account_move_line aml				
	where					
		aml.move_id = am.id				
		and aml.account_internal_type = 'other'				
		and aml.exclude_from_invoice_tab = true				
		and aml.name like '%ISR%'),				
	0) + coalesce ((					
	select					
		sum(aml.debit)				
	from					
		account_move_line aml				
	where					
		aml.move_id = am.id				
		and aml.account_internal_type = 'other'				
		and aml.exclude_from_invoice_tab = true				
		and aml.name like '%ISR%'),				
	0)) as monto_facturado_propina,					
	(					
	case					
		when (				
		select				
			aj.l10n_do_payment_form			
		from				
			account_payment ap			
		inner join account_journal aj on				
			ap.journal_id = aj.id			
		where				
			ap.communication = am.name			
		order by				
			ap.id desc			
		limit 1) is null then 'Credito'				
		else 				
			case			
				when 		
				(select		
					aj.l10n_do_payment_form	
				from		
					account_payment ap	
				inner join account_journal aj on		
					ap.journal_id = aj.id	
				where		
					ap.communication = am.name	
				order by		
					ap.id desc	
				limit 1		
				) = 'cash' then 'Efectivo' 		
				when		
				(select		
					aj.l10n_do_payment_form	
				from		
					account_payment ap	
				inner join account_journal aj on		
					ap.journal_id = aj.id	
				where		
					ap.communication = am.name	
				order by		
					ap.id desc	
				limit 1		
				) = 'bank' then 'Cheque / Transferencia' 		
				when		
				(select		
					aj.l10n_do_payment_form	
				from		
					account_payment ap	
				inner join account_journal aj on		
					ap.journal_id = aj.id	
				where		
					ap.communication = am.name	
				order by		
					ap.id desc	
				limit 1		
				) = 'card' then 'Tarjeta de Credito / Debito' 		
				when		
				(select		
					aj.l10n_do_payment_form	
				from		
					account_payment ap	
				inner join account_journal aj on		
					ap.journal_id = aj.id	
				where		
					ap.communication = am.name	
				order by		
					ap.id desc	
				limit 1		
				) = 'credit' then 'Credito' 		
				when		
				(select		
					aj.l10n_do_payment_form	
				from		
					account_payment ap	
				inner join account_journal aj on		
					ap.journal_id = aj.id	
				where		
					ap.communication = am.name	
				order by		
					ap.id desc	
				limit 1		
				) = 'swap' then 'Permuta' 		
				when		
				(select		
					aj.l10n_do_payment_form	
				from		
					account_payment ap	
				inner join account_journal aj on		
					ap.journal_id = aj.id	
				where		
					ap.communication = am.name	
				order by		
					ap.id desc	
				limit 1		
				) = 'bond' then 'Bonos o Certificados de Regalo' 		
				when		
				(select		
					aj.l10n_do_payment_form	
				from		
					account_payment ap	
				inner join account_journal aj on		
					ap.journal_id = aj.id	
				where		
					ap.communication = am.name	
				order by		
					ap.id desc	
				limit 1		
				) = 'others' then 'Otras Formas de Venta' 		
				end		
	end) as forma_pago					 FROM account_move am
					inner join res_partner rp on
					rp.id = am.partner_id WHERE am.type in ('out_invoice',
					'out_refund')
					and am.ref != ''
					and am.state = 'posted'