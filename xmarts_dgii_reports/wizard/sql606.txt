SELECT 	am.id,			
	am.id as invoice_id,			
	(			
	select			
		rc2.name		
	from			
		res_currency rc2		
	where			
		rc2.id = am.currency_id) as moneda,		
	rp.vat as rnc,			
	rp.name as provider_name,			
	case 		
		when am.l10n_do_expense_type = '01' then '01 - Gastos de Personal'	
		when am.l10n_do_expense_type = '02' then '02 - Gastos por Trabajo, Suministros y Servicios'	
		when am.l10n_do_expense_type = '03' then '03 - Arrendamientos'	
		when am.l10n_do_expense_type = '04' then '04 - Gastos de Activos Fijos'	
		when am.l10n_do_expense_type = '05' then '05 - Gastos de Representacion'	
		when am.l10n_do_expense_type = '06' then '06 - Otras Deducciones Admitidas'	
		when am.l10n_do_expense_type = '07' then '07 - Gastos Financieros'	
		when am.l10n_do_expense_type = '08' then '08 - Gastos Extraordinarios'	
		when am.l10n_do_expense_type = '09' then '09 - Compras y Gastos que forman parte del Costo de Venta'	
		when am.l10n_do_expense_type = '10' then '10 - Adquisiciones de Activos'	
		when am.l10n_do_expense_type = '11' then '11 - Gastos de Seguros'	
	else '' end as tipo_bien_servicio,		
	am.ref as ncf,			
	am.l10n_do_origin_ncf as ncf_modificado,			
	am.invoice_date as invoice_date,			
	to_char(am.invoice_date, 'DD/MM/YYYY') as fecha_emision,		
	coalesce ((			
	select			
		to_char(ap.payment_date, 'DD/MM/YYYY')		
	from			
		account_payment ap		
	where			
		ap.communication = am.ref		
	order by			
		ap.id desc		
	limit 1),			
	'') as fecha_pago,			
	to_char(am.invoice_date, 'YYYYMM') as fecha_comprobante_am,		
	to_char(am.invoice_date, 'DD') as fecha_comprobante_d,		
	coalesce ((			
	select			
		to_char(ap.payment_date, 'YYYYMM')		
	from			
		account_payment ap		
	where			
		ap.communication = am.ref		
	order by			
		ap.id desc		
	limit 1),			
	'') as fecha_pago_am,			
	coalesce ((			
	select			
		to_char(ap.payment_date, 'DD')		
	from			
		account_payment ap		
	where			
		ap.communication = am.ref		
	order by			
		ap.id desc		
	limit 1),			
	'') as fecha_pago_d,			
	((coalesce ((			
	select			
		sum(aml.credit)		
	from			
		account_move_line aml		
	inner join product_product pp on			
		aml.product_id = pp.id		
	inner join product_template pt on			
		pt.id = pp.product_tmpl_id		
	where			
		pt.type = 'service'		
		and aml.move_id = am.id		
		and aml.account_internal_type = 'other'		
		and aml.exclude_from_invoice_tab = false		
		and aml.product_id is not null),		
	0)+ coalesce ((			
	select			
		sum(aml.credit)		
	from			
		account_move_line aml		
	where			
		aml.move_id = am.id		
		and aml.account_internal_type = 'other'		
		and aml.exclude_from_invoice_tab = false		
		and aml.product_id is null),		
	0))+ (coalesce ((			
	select			
		sum(aml.debit)		
	from			
		account_move_line aml		
	inner join product_product pp on			
		aml.product_id = pp.id		
	inner join product_template pt on			
		pt.id = pp.product_tmpl_id		
	where			
		pt.type = 'service'		
		and aml.move_id = am.id		
		and aml.account_internal_type = 'other'		
		and aml.exclude_from_invoice_tab = false		
		and aml.product_id is not null),		
	0)+ coalesce ((			
	select			
		sum(aml.debit)		
	from			
		account_move_line aml		
	where			
		aml.move_id = am.id		
		and aml.account_internal_type = 'other'		
		and aml.exclude_from_invoice_tab = false		
		and aml.product_id is null),		
	0))) as monto_facturado,			
	(coalesce ((			
	select			
		sum(aml.credit)		
	from			
		account_move_line aml		
	inner join product_product pp on			
		aml.product_id = pp.id		
	inner join product_template pt on			
		pt.id = pp.product_tmpl_id		
	where			
		pt.type not in ('service')		
		and aml.move_id = am.id		
		and aml.account_internal_type = 'other'		
		and aml.exclude_from_invoice_tab = false),		
	0) + coalesce ((			
	select			
		sum(aml.debit)		
	from			
		account_move_line aml		
	inner join product_product pp on			
		aml.product_id = pp.id		
	inner join product_template pt on			
		pt.id = pp.product_tmpl_id		
	where			
		pt.type not in ('service')		
		and aml.move_id = am.id		
		and aml.account_internal_type = 'other'		
		and aml.exclude_from_invoice_tab = false),		
	0)) as monto_bienes,			
	(coalesce ((			
	select			
		sum(aml.credit)		
	from			
		account_move_line aml		
	where			
		aml.move_id = am.id		
		and aml.account_internal_type = 'other'		
		and aml.exclude_from_invoice_tab = false),		
	0) + coalesce ((			
	select			
		sum(aml.debit)		
	from			
		account_move_line aml		
	where			
		aml.move_id = am.id		
		and aml.account_internal_type = 'other'		
		and aml.exclude_from_invoice_tab = false),		
	0)) as monto_facturado_aitbis,			
	(coalesce ((			
	select			
		sum(aml.credit)		
	from			
		account_move_line aml		
	where			
		aml.move_id = am.id		
		and aml.account_internal_type = 'other'		
		and aml.exclude_from_invoice_tab = true		
		and aml.name like '%ITBIS%'),		
	0) + coalesce ((			
	select			
		sum(aml.debit)		
	from			
		account_move_line aml		
	where			
		aml.move_id = am.id		
		and aml.account_internal_type = 'other'		
		and aml.exclude_from_invoice_tab = true		
		and aml.name like '%ITBIS%'),		
	0)) as monto_facturado_itbis,			
	(coalesce ((			
	select			
		sum(aml.credit)		
	from			
		account_move_line aml		
	inner join account_payment ap on			
		ap.id = aml.payment_id		
	inner join account_account aa on			
		aa.id = aml.account_id		
	where			
		aml.ref = am.ref		
		and (aa.name like '%Reten%'		
		and aa.name like '%ITBIS%')		
		and ap.id = (		
		select		
			ap.id	
		from		
			account_payment ap	
		where		
			ap.communication = am.ref	
		order by		
			ap.id desc	
		limit 1)),		
	0) + coalesce ((			
	select			
		sum(aml.debit)		
	from			
		account_move_line aml		
	inner join account_payment ap on			
		ap.id = aml.payment_id		
	inner join account_account aa on			
		aa.id = aml.account_id		
	where			
		aml.ref = am.ref		
		and (aa.name like '%Reten%'		
		and aa.name like '%ITBIS%')		
		and ap.id = (		
		select		
			ap.id	
		from		
			account_payment ap	
		where		
			ap.communication = am.ref	
		order by		
			ap.id desc	
		limit 1)),		
	0)) as itbis_retenido,			
	case			
		when coalesce ((		
		select		
			count(aml3.id)	
		from		
			account_move_line aml3	
		inner join account_move am3 on		
			am3.id = aml3.move_id	
		where		
			am3.type in ('out_invoice',	
			'out_refund')	
			and am3.state = 'posted'	
			and (am3.ref like 'B01%'	
			or am3.ref like 'B02%')	
			and to_char(am3.invoice_date , 'MM-YYYY') = to_char(am.invoice_date , 'MM-YYYY')	
			and aml3.account_internal_type = 'other'	
			and aml3.exclude_from_invoice_tab = true	
			and aml3.name not like '%ITBIS%'),	
		0) > 0 then (coalesce ((		
		select		
			sum(aml.credit)	
		from		
			account_move_line aml	
		where		
			aml.move_id = am.id	
			and aml.account_internal_type = 'other'	
			and aml.exclude_from_invoice_tab = true	
			and aml.name like '%ITBIS%'),	
		0) + coalesce ((		
		select		
			sum(aml.debit)	
		from		
			account_move_line aml	
		where		
			aml.move_id = am.id	
			and aml.account_internal_type = 'other'	
			and aml.exclude_from_invoice_tab = true	
			and aml.name like '%ITBIS%'),	
		0))		
		else 0		
	end as itbis_sujeto_proporcionalidad,			
	case			
		when am.itbis_to_cost = true then (coalesce ((		
		select		
			sum(aml.credit)	
		from		
			account_move_line aml	
		where		
			aml.move_id = am.id	
			and aml.account_internal_type = 'other'	
			and aml.exclude_from_invoice_tab = true	
			and aml.name like '%ITBIS%'),	
		0) + coalesce ((		
		select		
			sum(aml.debit)	
		from		
			account_move_line aml	
		where		
			aml.move_id = am.id	
			and aml.account_internal_type = 'other'	
			and aml.exclude_from_invoice_tab = true	
			and aml.name like '%ITBIS%'),	
		0))		
		else 0		
	end as itbis_llevado_costo,			
	case			
		when am.itbis_to_cost = true 		
		then 		
			case 	
			when am.itbis_to_cost_type = 'bienes_productores_exentos' then 'Bienes - Productores Exentos'	
			when am.itbis_to_cost_type = 'bienes_activos_cat_1' then 'Bienes - Activos Cat. 1'	
			when am.itbis_to_cost_type = 'bienes_otros' then 'Bienes - Otros'	
			when am.itbis_to_cost_type = 'servicios_productores_exentos' then 'Servicios - Productores Exentos'	
			else '' end	
		else ''		
	end as tipo_itbis_llevado_costo,			
	case			
		when coalesce ((		
		select		
			count(aml3.id)	
		from		
			account_move_line aml3	
		inner join account_move am3 on		
			am3.id = aml3.move_id	
		where		
			am3.type in ('out_invoice',	
			'out_refund')	
			and am3.state = 'posted'	
			and (am3.ref like 'B01%'	
			or am3.ref like 'B02%')	
			and to_char(am3.invoice_date , 'MM-YYYY') = to_char(am.invoice_date , 'MM-YYYY')	
			and aml3.account_internal_type = 'other'	
			and aml3.exclude_from_invoice_tab = true	
			and aml3.name not like '%ITBIS%'),	
		0) = 0 then (coalesce ((		
		select		
			sum(aml.credit)	
		from		
			account_move_line aml	
		where		
			aml.move_id = am.id	
			and aml.account_internal_type = 'other'	
			and aml.exclude_from_invoice_tab = true	
			and aml.name like '%ITBIS%'),	
		0) + coalesce ((		
		select		
			sum(aml.debit)	
		from		
			account_move_line aml	
		where		
			aml.move_id = am.id	
			and aml.account_internal_type = 'other'	
			and aml.exclude_from_invoice_tab = true	
			and aml.name like '%ITBIS%'),	
		0))		
		else 0		
	end as itbis_adelantar,			
	case			
		when ((coalesce ((		
		select		
			sum(aml.credit)	
		from		
			account_move_line aml	
		inner join product_product pp on		
			aml.product_id = pp.id	
		inner join product_template pt on		
			pt.id = pp.product_tmpl_id	
		where		
			pt.type = 'servicio'	
			and aml.move_id = am.id	
			and aml.account_internal_type = 'other'	
			and aml.exclude_from_invoice_tab = false	
			and aml.product_id is not null),	
		0)+ coalesce ((		
		select		
			sum(aml.credit)	
		from		
			account_move_line aml	
		where		
			aml.move_id = am.id	
			and aml.account_internal_type = 'other'	
			and aml.exclude_from_invoice_tab = false	
			and aml.product_id is null),	
		0)) + (coalesce ((		
		select		
			sum(aml.debit)	
		from		
			account_move_line aml	
		inner join product_product pp on		
			aml.product_id = pp.id	
		inner join product_template pt on		
			pt.id = pp.product_tmpl_id	
		where		
			pt.type = 'servicio'	
			and aml.move_id = am.id	
			and aml.account_internal_type = 'other'	
			and aml.exclude_from_invoice_tab = false	
			and aml.product_id is not null),	
		0)+ coalesce ((		
		select		
			sum(aml.debit)	
		from		
			account_move_line aml	
		where		
			aml.move_id = am.id	
			and aml.account_internal_type = 'other'	
			and aml.exclude_from_invoice_tab = false	
			and aml.product_id is null),	
		0))) >= 0 then 'Servicios gravados'		
		else 'Bienes gravados'		
	end as tipo_itbis_por_adelantar,			
	coalesce (null,			
	'') as itbis_percibido_compras,			
	case 				
		when coalesce ((			
		select			
			aa.isr_retencion_type		
		from			
			account_move_line aml		
		inner join account_payment ap on			
			ap.id = aml.payment_id		
		inner join account_account aa on			
			aa.id = aml.account_id		
		where			
			aml.ref = am.ref		
			and (aa.name like '%Reten%'		
			and aa.name like '%ISR%')		
			and ap.id = (		
			select		
				ap.id	
			from		
				account_payment ap	
			where		
				ap.communication = am.ref	
			order by		
				ap.id desc	
			limit 1)),		
		'') = '' then ''			
		when coalesce ((			
		select			
			aa.isr_retencion_type		
		from			
			account_move_line aml		
		inner join account_payment ap on			
			ap.id = aml.payment_id		
		inner join account_account aa on			
			aa.id = aml.account_id		
		where			
			aml.ref = am.ref		
			and (aa.name like '%Reten%'		
			and aa.name like '%ISR%')		
			and ap.id = (		
			select		
				ap.id	
			from		
				account_payment ap	
			where		
				ap.communication = am.ref	
			order by		
				ap.id desc	
			limit 1)),		
		'') = '01' then '01 - Alquileres'			
		when coalesce ((			
		select			
			aa.isr_retencion_type		
		from			
			account_move_line aml		
		inner join account_payment ap on			
			ap.id = aml.payment_id		
		inner join account_account aa on			
			aa.id = aml.account_id		
		where			
			aml.ref = am.ref		
			and (aa.name like '%Reten%'		
			and aa.name like '%ISR%')		
			and ap.id = (		
			select		
				ap.id	
			from		
				account_payment ap	
			where		
				ap.communication = am.ref	
			order by		
				ap.id desc	
			limit 1)),		
		'') = '02' then '02 - Honorarios Por Servicios'			
		when coalesce ((			
		select			
			aa.isr_retencion_type		
		from			
			account_move_line aml		
		inner join account_payment ap on			
			ap.id = aml.payment_id		
		inner join account_account aa on			
			aa.id = aml.account_id		
		where			
			aml.ref = am.ref		
			and (aa.name like '%Reten%'		
			and aa.name like '%ISR%')		
			and ap.id = (		
			select		
				ap.id	
			from		
				account_payment ap	
			where		
				ap.communication = am.ref	
			order by		
				ap.id desc	
			limit 1)),		
		'03') = '' then '03 - Otras Rentas'			
		when coalesce ((			
		select			
			aa.isr_retencion_type		
		from			
			account_move_line aml		
		inner join account_payment ap on			
			ap.id = aml.payment_id		
		inner join account_account aa on			
			aa.id = aml.account_id		
		where			
			aml.ref = am.ref		
			and (aa.name like '%Reten%'		
			and aa.name like '%ISR%')		
			and ap.id = (		
			select		
				ap.id	
			from		
				account_payment ap	
			where		
				ap.communication = am.ref	
			order by		
				ap.id desc	
			limit 1)),		
		'') = '04' then '04 - Otras Rentas (Rentas Presuntas)' end			
	as tipo_isr_retenido,				
	(coalesce ((			
	select			
		sum(aml.credit)		
	from			
		account_move_line aml		
	inner join account_payment ap on			
		ap.id = aml.payment_id		
	inner join account_account aa on			
		aa.id = aml.account_id		
	where			
		aml.ref = am.ref		
		and aa.name like '%Reten%'		
		and aa.name like '%ISR%'		
		and ap.id = (		
		select		
			ap.id	
		from		
			account_payment ap	
		where		
			ap.communication = am.ref	
		order by		
			ap.id desc	
		limit 1)),		
	0) + coalesce ((			
	select			
		sum(aml.debit)		
	from			
		account_move_line aml		
	inner join account_payment ap on			
		ap.id = aml.payment_id		
	inner join account_account aa on			
		aa.id = aml.account_id		
	where			
		aml.ref = am.ref		
		and aa.name like '%Reten%'		
		and aa.name like '%ISR%'		
		and ap.id = (		
		select		
			ap.id	
		from		
			account_payment ap	
		where		
			ap.communication = am.ref	
		order by		
			ap.id desc	
		limit 1)),		
	0)) as isr_retenido,			
	(coalesce ((			
	select			
		sum(aml.credit)		
	from			
		account_move_line aml		
	where			
		aml.move_id = am.id		
		and aml.account_internal_type = 'other'		
		and aml.exclude_from_invoice_tab = true		
		and aml.name like '%ISC%'),		
	0) + coalesce ((			
	select			
		sum(aml.debit)		
	from			
		account_move_line aml		
	where			
		aml.move_id = am.id		
		and aml.account_internal_type = 'other'		
		and aml.exclude_from_invoice_tab = true		
		and aml.name like '%ISC%'),		
	0)) as monto_facturado_isc,			
	( coalesce ((			
	select			
		sum(aml.credit)		
	from			
		account_move_line aml		
	where			
		aml.move_id = am.id		
		and aml.account_internal_type = 'other'		
		and aml.exclude_from_invoice_tab = true		
		and (aml.name not like '%Propina Legal%'		
		or aml.name not like '%ISC%'		
		or aml.name not like '%ITBIS%'		
		or aml.name not like '%ISR%')),		
	0) - coalesce ((			
	select			
		sum(aml.credit)		
	from			
		account_move_line aml		
	where			
		aml.move_id = am.id		
		and aml.account_internal_type = 'other'		
		and aml.exclude_from_invoice_tab = true		
		and (aml.name like '%Propina Legal%'		
		or aml.name like '%ISC%'		
		or aml.name like '%ITBIS%'		
		or aml.name like '%ISR%')),		
	0)) + ( coalesce ((			
	select			
		sum(aml.debit)		
	from			
		account_move_line aml		
	where			
		aml.move_id = am.id		
		and aml.account_internal_type = 'other'		
		and aml.exclude_from_invoice_tab = true		
		and (aml.name not like '%Propina Legal%'		
		or aml.name not like '%ISC%'		
		or aml.name not like '%ITBIS%'		
		or aml.name not like '%ISR%')),		
	0) - coalesce ((			
	select			
		sum(aml.debit)		
	from			
		account_move_line aml		
	where			
		aml.move_id = am.id		
		and aml.account_internal_type = 'other'		
		and aml.exclude_from_invoice_tab = true		
		and (aml.name like '%Propina Legal%'		
		or aml.name like '%ISC%'		
		or aml.name like '%ITBIS%'		
		or aml.name like '%ISR%')),		
	0)) as monto_otros_imp,			
	(coalesce ((			
	select			
		sum(aml.credit)		
	from			
		account_move_line aml		
	where			
		aml.move_id = am.id		
		and aml.account_internal_type = 'other'		
		and aml.exclude_from_invoice_tab = true		
		and aml.name like '%Propina Legal%'),		
	0) + coalesce ((			
	select			
		sum(aml.debit)		
	from			
		account_move_line aml		
	where			
		aml.move_id = am.id		
		and aml.account_internal_type = 'other'		
		and aml.exclude_from_invoice_tab = true		
		and aml.name like '%Propina Legal%'),		
	0)) as monto_facturado_propina,			
	coalesce (null,			
	'') as isr_percibido_compras,			
	(					
	case					
		when (				
		select				
			aj.l10n_do_payment_form			
		from				
			account_payment ap			
		inner join account_journal aj on				
			ap.journal_id = aj.id			
		where				
			ap.communication = am.ref			
		order by				
			ap.id desc			
		limit 1) is null then 'Credito'				
		else 				
			case			
				when 		
				(select		
					aj.l10n_do_payment_form	
				from		
					account_payment ap	
				inner join account_journal aj on		
					ap.journal_id = aj.id	
				where		
					ap.communication = am.ref	
				order by		
					ap.id desc	
				limit 1		
				) = 'cash' then 'Efectivo' 		
				when		
				(select		
					aj.l10n_do_payment_form	
				from		
					account_payment ap	
				inner join account_journal aj on		
					ap.journal_id = aj.id	
				where		
					ap.communication = am.ref	
				order by		
					ap.id desc	
				limit 1		
				) = 'bank' then 'Cheque / Transferencia' 		
				when		
				(select		
					aj.l10n_do_payment_form	
				from		
					account_payment ap	
				inner join account_journal aj on		
					ap.journal_id = aj.id	
				where		
					ap.communication = am.ref	
				order by		
					ap.id desc	
				limit 1		
				) = 'card' then 'Tarjeta de Credito / Debito' 		
				when		
				(select		
					aj.l10n_do_payment_form	
				from		
					account_payment ap	
				inner join account_journal aj on		
					ap.journal_id = aj.id	
				where		
					ap.communication = am.ref	
				order by		
					ap.id desc	
				limit 1		
				) = 'credit' then 'Credito' 		
				when		
				(select		
					aj.l10n_do_payment_form	
				from		
					account_payment ap	
				inner join account_journal aj on		
					ap.journal_id = aj.id	
				where		
					ap.communication = am.ref	
				order by		
					ap.id desc	
				limit 1		
				) = 'swap' then 'Permuta' 		
				when		
				(select		
					aj.l10n_do_payment_form	
				from		
					account_payment ap	
				inner join account_journal aj on		
					ap.journal_id = aj.id	
				where		
					ap.communication = am.ref	
				order by		
					ap.id desc	
				limit 1		
				) = 'bond' then 'Bonos o Certificados de Regalo' 		
				when		
				(select		
					aj.l10n_do_payment_form	
				from		
					account_payment ap	
				inner join account_journal aj on		
					ap.journal_id = aj.id	
				where		
					ap.communication = am.ref	
				order by		
					ap.id desc	
				limit 1		
				) = 'others' then 'Otras Formas de Venta' 		
				end		
	end) as forma_pago					 FROM account_move am
					inner join res_partner rp on
					rp.id = am.partner_id WHERE am.type in ('in_invoice',
					'in_refund')
					and am.ref != ''
					and am.state = 'posted'